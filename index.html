<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth & API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Authentication & API Test Utility</h1>

        <div id="status-message" class="p-3 mb-6 rounded-lg font-medium hidden" role="alert"></div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Token Section -->
            <div class="bg-gray-100 p-5 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Get Current ID Token</h2>
                <button id="getTokenBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-md disabled:bg-blue-300" disabled>
                    Get ID Token
                </button>
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-600 mb-2">ID Token Preview (For Backend):</h3>
                    <div id="token-display" class="bg-white p-3 rounded-lg text-sm text-gray-700 break-all min-h-[50px] overflow-auto border border-gray-300">
                        Token: Click 'Get ID Token'
                    </div>
                </div>
            </div>

            <!-- API Call Section -->
            <div class="bg-gray-100 p-5 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">2. Call Protected API</h2>
                <button id="callApiBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-indigo-300" disabled>
                    Call Protected Flask API
                </button>
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-600 mb-2">API Response:</h3>
                    <div id="api-response-display" class="bg-white p-3 rounded-lg text-sm text-gray-700 break-all min-h-[50px] overflow-auto border border-gray-300">
                        Response will appear here.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 pt-6 border-t border-gray-200">
             <h3 class="text-lg font-semibold text-gray-600 mb-2">Current User Status</h3>
             <p id="user-status" class="text-gray-700 text-sm">Initializing...</p>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION HANDLING (Use Environment Vars) ---
        // We prioritize __firebase_config and __initial_auth_token provided by the environment.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
                               ? JSON.parse(__firebase_config) 
                               : {}; // Fallback empty object if env config is missing

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;
        let currentUser = null;

        // --- UI ELEMENTS ---
        const statusMessageEl = document.getElementById('status-message');
        const userStatusEl = document.getElementById('user-status');
        const tokenDisplayEl = document.getElementById('token-display');
        const apiResponseDisplayEl = document.getElementById('api-response-display');
        const getTokenBtn = document.getElementById('getTokenBtn');
        const callApiBtn = document.getElementById('callApiBtn');
        
        const MOCK_API_ENDPOINT = "/api/protected"; 

        /**
         * Utility function to display messages in the status area.
         * @param {string} message 
         * @param {string} type 'success', 'error', 'info'
         */
        function showStatus(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.className = 'p-3 mb-6 rounded-lg font-medium';
            statusMessageEl.classList.remove('hidden');

            switch (type) {
                case 'success':
                    statusMessageEl.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    statusMessageEl.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    statusMessageEl.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }
            console.log(`[Status] ${message}`);
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                // 1. Initialize App with the environment configuration
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable detailed console logging

                showStatus("Firebase initialized successfully using environment configuration.", 'success');

                // 2. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        const status = `Authenticated. User ID: ${user.uid}`;
                        userStatusEl.textContent = status;
                        
                        // Enable buttons once auth is ready
                        getTokenBtn.disabled = false;
                        callApiBtn.disabled = false;
                        showStatus("User signed in successfully (Anonymously or via Token).", 'success');
                    } else {
                        userStatusEl.textContent = 'Not authenticated.';
                        currentUser = null;
                        getTokenBtn.disabled = true;
                        callApiBtn.disabled = true;
                        showStatus("User signed out or failed to authenticate.", 'error');
                    }
                });


                // 3. Handle Authentication (Attempt Custom Token ONLY)
                // We SKIP the anonymous sign-in fallback because the project is rejecting it 
                // with 'auth/admin-restricted-operation'.
                
                if (initialAuthToken) {
                    userStatusEl.textContent = 'Attempting sign-in with custom token...';
                    try {
                        // Attempt 1: Custom Token
                        await signInWithCustomToken(auth, initialAuthToken);
                        showStatus("Signed in with custom token.", 'success');
                    } catch (error) {
                        // Custom Token Failed (e.g., auth/custom-token-mismatch)
                        console.error("Custom Token Sign-In Failed:", error);
                        showStatus(`Authentication failed. Custom token was rejected (${error.code}).`, 'error');
                    }
                } else {
                    showStatus("No custom token provided. Awaiting manual sign-in.", 'info');
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`FATAL Initialization Error: ${error.message}. Check your console for details.`, 'error');
                userStatusEl.textContent = `Error: ${error.message}`;
            }
        }

        /**
         * Gets the current Firebase ID Token.
         */
        async function getToken() {
            if (!currentUser) {
                showStatus("Error: User is not authenticated.", 'error');
                tokenDisplayEl.textContent = "Error: User is not authenticated.";
                return;
            }
            
            try {
                // Force refresh to ensure the token is up-to-date
                const token = await currentUser.getIdToken(true); 
                tokenDisplayEl.textContent = token;
                showStatus("Successfully retrieved REAL Firebase ID Token.", 'success');
                return token;
            } catch (error) {
                console.error("Error getting ID token:", error);
                showStatus(`Failed to get ID token: ${error.message}`, 'error');
                tokenDisplayEl.textContent = `Error getting token: ${error.message}`;
                return null;
            }
        }

        /**
         * Calls a mock protected API using the ID Token in the Authorization header.
         */
        async function callProtectedApi() {
            apiResponseDisplayEl.textContent = "Calling API...";
            showStatus("Attempting to call protected API endpoint...", 'info');
            
            // 1. Get the current ID Token
            const token = await getToken();
            if (!token) {
                apiResponseDisplayEl.textContent = "API call aborted: Could not retrieve ID token.";
                return;
            }

            // 2. Make the API Call
            try {
                // Explicitly constructing the absolute URL
                const apiUrl = window.location.origin + MOCK_API_ENDPOINT;

                // The backend (Flask/Express/etc.) would receive this request and verify the token.
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        // CRITICAL STEP: Attach the ID Token as a Bearer Token
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const responseText = await response.text();

                if (response.ok) {
                    apiResponseDisplayEl.textContent = 
                        `Status: ${response.status} OK\n\n` + 
                        `Response Body:\n${responseText}`;
                    showStatus("API call succeeded. The token was sent successfully.", 'success');
                } else {
                     // In a real app, a 401 Unauthorized error would occur if the token was invalid
                    apiResponseDisplayEl.textContent = 
                        `Status: ${response.status} Failed\n\n` + 
                        `Response Body: ${responseText}`;
                    showStatus(`API call failed (Status ${response.status}). The token was likely invalid for the backend.`, 'error');
                }

            } catch (error) {
                console.error("API Call Error:", error);
                apiResponseDisplayEl.textContent = `Network Error: ${error.message}. (Ensure MOCK_API_ENDPOINT is reachable).`;
                showStatus(`API call failed due to a network or fetch error: ${error.message}`, 'error');
            }
        }

        // --- EVENT LISTENERS ---
        getTokenBtn.addEventListener('click', getToken);
        callApiBtn.addEventListener('click', callProtectedApi);

        // --- START APP ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
